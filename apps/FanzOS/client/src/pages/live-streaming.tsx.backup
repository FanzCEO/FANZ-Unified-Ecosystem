import { useState, useRef, useEffect, useCallback, useMemo } from "react";
import { useQuery, useMutation, useQueryClient } from "@tanstack/react-query";
import { useAuth } from "@/hooks/useAuth";
import { useToast } from "@/hooks/use-toast";
import Navigation from "@/components/navigation";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Avatar, AvatarFallback, AvatarImage } from "@/components/ui/avatar";
import { ScrollArea } from "@/components/ui/scroll-area";
import { Textarea } from "@/components/ui/textarea";
import { Skeleton } from "@/components/ui/skeleton";
import { Alert, AlertDescription } from "@/components/ui/alert";
import { Slider } from "@/components/ui/slider";
import { Separator } from "@/components/ui/separator";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
  DialogFooter,
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Label } from "@/components/ui/label";
import { Checkbox } from "@/components/ui/checkbox";
import {
  Play,
  Pause,
  Volume2,
  VolumeX,
  Heart,
  MessageCircle,
  Users,
  Eye,
  Gift,
  Share2,
  Settings,
  Calendar,
  Clock,
  TrendingUp,
  Search,
  Star,
  Crown,
  Zap,
  DollarSign,
  Maximize2,
  Minimize2,
  Camera,
  Mic,
  MicOff,
  VideoOff,
  Video,
  MoreVertical,
  Bell,
  Bookmark,
  Flag,
  StopCircle,
  FileVideo,
  UserPlus,
  Shield,
  AlertTriangle,
  CheckCircle,
  XCircle,
  Monitor,
  Wifi,
  WifiOff
} from "lucide-react";
import { Link } from "wouter";

interface LiveStream {
  id: string;
  title: string;
  description: string;
  creatorId: string;
  creatorName: string;
  creatorAvatar: string;
  thumbnailUrl: string;
  streamUrl: string;
  isLive: boolean;
  startedAt: string;
  viewers: number;
  totalViews: number;
  category: string;
  tags: string[];
  isPremium: boolean;
  ticketPrice?: number;
  tipGoal?: number;
  currentTips?: number;
  duration?: number;
  isFollowing?: boolean;
  hasNotifications?: boolean;
  isRecording?: boolean;
  recordingUrl?: string;
  hasCoStars?: boolean;
  coStars?: CoStar[];
  complianceVerified?: boolean;
  videoQuality?: 'auto' | '1080p' | '720p' | '480p' | '360p';
}

interface CoStar {
  id: string;
  name: string;
  avatar: string;
  verificationStatus: 'pending' | 'verified' | 'rejected';
  documentationComplete: boolean;
  ageVerified: boolean;
  consentGiven: boolean;
  joinedAt: string;
}

interface ChatMessage {
  id: string;
  userId: string;
  username: string;
  userAvatar: string;
  message: string;
  timestamp: string;
  isVip?: boolean;
  isModerator?: boolean;
  tipAmount?: number;
}

interface TipOption {
  amount: number;
  emoji: string;
  message: string;
}

export default function LiveStreamingPage() {
  const { user } = useAuth();
  const { toast } = useToast();
  const [searchQuery, setSearchQuery] = useState("");
  const [debouncedSearchQuery, setDebouncedSearchQuery] = useState("");
  const [selectedCategory, setSelectedCategory] = useState("all");
  const [selectedStream, setSelectedStream] = useState<LiveStream | null>(null);
  const [isFullscreen, setIsFullscreen] = useState(false);
  const [chatMessage, setChatMessage] = useState("");
  const [showTipModal, setShowTipModal] = useState(false);
  const [tipAmount, setTipAmount] = useState("");
  const [tipMessage, setTipMessage] = useState("");
  const [volume, setVolume] = useState([75]);
  const [isVideoMuted, setIsVideoMuted] = useState(false);
  const [showVideoControls, setShowVideoControls] = useState(true);
  const [chatMessages, setChatMessages] = useState<ChatMessage[]>([]);
  const [isConnected, setIsConnected] = useState(false);
  const [connectionError, setConnectionError] = useState<string | null>(null);
  const [isRecording, setIsRecording] = useState(false);
  const [recordingDuration, setRecordingDuration] = useState(0);
  const [showCoStarModal, setShowCoStarModal] = useState(false);
  const [coStarName, setCoStarName] = useState('');
  const [coStarEmail, setCoStarEmail] = useState('');
  const [videoQuality, setVideoQuality] = useState<string>('auto');
  const [streamBitrate, setStreamBitrate] = useState(2500);
  const [showComplianceAlert, setShowComplianceAlert] = useState(false);
  const videoRef = useRef<HTMLVideoElement>(null);
  const chatEndRef = useRef<HTMLDivElement>(null);
  const controlsTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const wsRef = useRef<WebSocket | null>(null);
  const recordingIntervalRef = useRef<NodeJS.Timeout | null>(null);
  const queryClient = useQueryClient();

  const { data: liveStreams, isLoading: streamsLoading, error: streamsError } = useQuery({
    queryKey: ["/api/streams/live"],
    retry: 2,
    staleTime: 30000,
    refetchInterval: 60000,
  });

  const { data: scheduledStreams, isLoading: scheduledLoading } = useQuery({
    queryKey: ["/api/streams/scheduled"],
    retry: 2,
    staleTime: 300000,
  });

  const { data: unreadCount = 0 } = useQuery({
    queryKey: ["/api/messages/unread/count"],
    retry: false,
  });

  // Real-time chat simulation with WebSocket
  useEffect(() => {
    if (!selectedStream) return;

    const connectWebSocket = () => {
      try {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        wsRef.current = new WebSocket(wsUrl);

        wsRef.current.onopen = () => {
          setIsConnected(true);
          setConnectionError(null);
          // Join stream room
          wsRef.current?.send(JSON.stringify({
            type: 'join_stream',
            streamId: selectedStream.id
          }));
        };

        wsRef.current.onmessage = (event) => {
          const data = JSON.parse(event.data);
          if (data.type === 'chat_message') {
            setChatMessages(prev => [...prev, data.message]);
          } else if (data.type === 'viewer_count') {
            // Update viewer count in real-time
            queryClient.invalidateQueries({ queryKey: ["/api/streams/live"] });
          }
        };

        wsRef.current.onclose = () => {
          setIsConnected(false);
          // Attempt to reconnect after 3 seconds
          setTimeout(connectWebSocket, 3000);
        };

        wsRef.current.onerror = () => {
          setConnectionError('Connection failed. Retrying...');
        };
      } catch (error) {
        setConnectionError('Failed to establish connection');
      }
    };

    connectWebSocket();

    return () => {
      if (wsRef.current) {
        wsRef.current.close();
      }
    };
  }, [selectedStream, queryClient]);

  // Debounced search
  useEffect(() => {
    const timer = setTimeout(() => {
      setDebouncedSearchQuery(searchQuery);
    }, 300);

    return () => clearTimeout(timer);
  }, [searchQuery]);

  // Mock data
  const mockStreams: LiveStream[] = (liveStreams as LiveStream[]) || [
    {
      id: "stream1",
      title: "Intimate Evening Chat - Ask Me Anything!",
      description: "Join me for an exclusive live session where we can chat about anything and everything. Your tips keep the conversation going!",
      creatorId: "creator1",
      creatorName: "Emma Rose",
      creatorAvatar: "https://images.unsplash.com/photo-1494790108344-b2ee30e40a34?w=100&h=100&fit=crop&crop=face",
      thumbnailUrl: "https://images.unsplash.com/photo-1493225457124-a3eb161ffa5f?w=800&h=600&fit=crop",
      streamUrl: "#",
      isLive: true,
      startedAt: "2024-01-20T20:00:00Z",
      viewers: 234,
      totalViews: 1547,
      category: "chat",
      tags: ["interactive", "q&a", "intimate"],
      isPremium: true,
      ticketPrice: 9.99,
      tipGoal: 500,
      currentTips: 347,
      isFollowing: true,
      hasNotifications: true
    },
    {
      id: "stream2",
      title: "Dance Performance & Audience Requests",
      description: "Live dance performance with song requests from the audience. Premium subscribers get special dedications!",
      creatorId: "creator2",
      creatorName: "Sophia Luna",
      creatorAvatar: "https://images.unsplash.com/photo-1502823403499-6ccfcf4fb453?w=100&h=100&fit=crop&crop=face",
      thumbnailUrl: "https://images.unsplash.com/photo-1571019613454-1cb2f99b2d8b?w=800&h=600&fit=crop",
      streamUrl: "#",
      isLive: true,
      startedAt: "2024-01-20T19:30:00Z",
      viewers: 567,
      totalViews: 2934,
      category: "performance",
      tags: ["dance", "music", "requests"],
      isPremium: false,
      tipGoal: 1000,
      currentTips: 782,
      isFollowing: false,
      hasNotifications: false
    },
    {
      id: "stream3",
      title: "Yoga & Wellness Session",
      description: "Morning yoga flow and wellness tips to start your day right. Interactive session with personalized advice.",
      creatorId: "creator3",
      creatorName: "Isabella Star",
      creatorAvatar: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100&h=100&fit=crop&crop=face",
      thumbnailUrl: "https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&h=600&fit=crop",
      streamUrl: "#",
      isLive: false,
      startedAt: "2024-01-21T08:00:00Z",
      viewers: 0,
      totalViews: 892,
      category: "fitness",
      tags: ["yoga", "wellness", "morning"],
      isPremium: false,
      tipGoal: 200,
      currentTips: 156,
      isFollowing: true,
      hasNotifications: true
    }
  ];

  const initialChatMessages: ChatMessage[] = [
    {
      id: "msg1",
      userId: "user1",
      username: "FanBoy23",
      userAvatar: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=50&h=50&fit=crop&crop=face",
      message: "Love this stream! ðŸ’•",
      timestamp: "2024-01-20T20:15:00Z",
      isVip: false,
      isModerator: false
    },
    {
      id: "msg2",
      userId: "user2", 
      username: "SupporterGirl",
      userAvatar: "https://images.unsplash.com/photo-1494790108344-b2ee30e40a34?w=50&h=50&fit=crop&crop=face",
      message: "Thanks for the amazing content!",
      timestamp: "2024-01-20T20:14:00Z",
      isVip: true,
      isModerator: false,
      tipAmount: 25
    },
    {
      id: "msg3",
      userId: "user3",
      username: "Moderator",
      userAvatar: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=50&h=50&fit=crop&crop=face",
      message: "Welcome everyone to tonight's stream!",
      timestamp: "2024-01-20T20:13:00Z",
      isVip: false,
      isModerator: true
    }
  ];

  // Initialize chat messages
  useEffect(() => {
    if (selectedStream && chatMessages.length === 0) {
      setChatMessages(initialChatMessages);
    }
  }, [selectedStream]);

  // Auto-scroll chat to bottom
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [chatMessages]);

  // Video controls auto-hide
  const handleMouseMove = useCallback(() => {
    setShowVideoControls(true);
    if (controlsTimeoutRef.current) {
      clearTimeout(controlsTimeoutRef.current);
    }
    controlsTimeoutRef.current = setTimeout(() => {
      setShowVideoControls(false);
    }, 3000);
  }, []);

  // Volume control
  useEffect(() => {
    if (videoRef.current) {
      videoRef.current.volume = volume[0] / 100;
      videoRef.current.muted = isVideoMuted;
    }
  }, [volume, isVideoMuted]);

  // Recording timer
  useEffect(() => {
    if (isRecording) {
      recordingIntervalRef.current = setInterval(() => {
        setRecordingDuration(prev => prev + 1);
      }, 1000);
    } else {
      if (recordingIntervalRef.current) {
        clearInterval(recordingIntervalRef.current);
      }
    }

    return () => {
      if (recordingIntervalRef.current) {
        clearInterval(recordingIntervalRef.current);
      }
    };
  }, [isRecording]);

  // Check for co-stars and compliance
  useEffect(() => {
    if (selectedStream?.hasCoStars && !selectedStream?.complianceVerified) {
      setShowComplianceAlert(true);
    }
  }, [selectedStream]);

  const categories = [
    { id: "all", name: "All", count: 89 },
    { id: "chat", name: "Chat", count: 23 },
    { id: "performance", name: "Performance", count: 18 },
    { id: "fitness", name: "Fitness", count: 12 },
    { id: "gaming", name: "Gaming", count: 15 },
    { id: "music", name: "Music", count: 21 }
  ];

  const tipOptions: TipOption[] = [
    { amount: 5, emoji: "ðŸ’•", message: "Love this!" },
    { amount: 10, emoji: "ðŸ”¥", message: "So hot!" },
    { amount: 25, emoji: "â­", message: "Amazing!" },
    { amount: 50, emoji: "ðŸ’Ž", message: "You're a diamond!" },
    { amount: 100, emoji: "ðŸ‘‘", message: "Queen/King!" }
  ];

  const sendChatMessage = useCallback(() => {
    if (!chatMessage.trim() || !selectedStream || !user) return;

    const newMessage: ChatMessage = {
      id: Date.now().toString(),
      userId: (user as any)?.id?.toString() || '',
      username: (user as any)?.username || 'Anonymous',
      userAvatar: (user as any)?.profilePicture || '',
      message: chatMessage,
      timestamp: new Date().toISOString(),
      isVip: (user as any)?.role === 'creator',
      isModerator: (user as any)?.role === 'admin'
    };

    // Send via WebSocket if connected
    if (wsRef.current && isConnected) {
      wsRef.current.send(JSON.stringify({
        type: 'send_message',
        streamId: selectedStream.id,
        message: newMessage
      }));
    } else {
      // Fallback to local state
      setChatMessages(prev => [...prev, newMessage]);
    }

    setChatMessage("");
  }, [chatMessage, selectedStream, user, isConnected]);

  const sendTip = useCallback(async (amount: number, message: string) => {
    if (!selectedStream || !user) return;

    try {
      // Show optimistic update
      const tipMessage: ChatMessage = {
        id: Date.now().toString(),
        userId: (user as any)?.id?.toString() || '',
        username: (user as any)?.username || 'Anonymous',
        userAvatar: (user as any)?.profilePicture || '',
        message: message || `Sent $${amount} tip! ðŸ’°`,
        timestamp: new Date().toISOString(),
        tipAmount: amount,
        isVip: (user as any)?.role === 'creator'
      };

      setChatMessages(prev => [...prev, tipMessage]);

      // Send tip via API
      await fetch('/api/streams/tip', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          streamId: selectedStream.id,
          amount,
          message
        })
      });

      toast({
        title: "Tip sent!",
        description: `You tipped $${amount} to ${selectedStream.creatorName}`,
      });

      setShowTipModal(false);
      setTipAmount("");
      setTipMessage("");
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to send tip. Please try again.",
        variant: "destructive"
      });
    }
  }, [selectedStream, user, toast]);

  const startRecording = useCallback(async () => {
    if (!selectedStream || !user || (user as any)?.role !== 'creator') return;

    try {
      const response = await fetch('/api/streams/start-recording', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ streamId: selectedStream.id })
      });

      if (response.ok) {
        setIsRecording(true);
        setRecordingDuration(0);
        toast({
          title: "Recording Started",
          description: "Your live stream is now being recorded",
        });
      }
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to start recording. Please try again.",
        variant: "destructive"
      });
    }
  }, [selectedStream, user, toast]);

  const stopRecording = useCallback(async () => {
    if (!selectedStream || !user) return;

    try {
      const response = await fetch('/api/streams/stop-recording', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          streamId: selectedStream.id,
          duration: recordingDuration
        })
      });

      if (response.ok) {
        const { recordingUrl } = await response.json();
        setIsRecording(false);
        toast({
          title: "Recording Saved",
          description: "Your stream has been saved to your vault",
        });
        
        // Refresh stream data
        queryClient.invalidateQueries({ queryKey: ["/api/streams/live"] });
      }
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to stop recording. Please try again.",
        variant: "destructive"
      });
    }
  }, [selectedStream, user, recordingDuration, toast, queryClient]);

  const addCoStar = useCallback(async () => {
    if (!selectedStream || !user || !coStarName || !coStarEmail) return;

    try {
      const response = await fetch('/api/streams/add-costar', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          streamId: selectedStream.id,
          name: coStarName,
          email: coStarEmail
        })
      });

      if (response.ok) {
        setShowCoStarModal(false);
        setCoStarName('');
        setCoStarEmail('');
        toast({
          title: "Co-star Added",
          description: "Co-star verification process initiated. Please ensure 2257 compliance.",
        });
        
        // Refresh stream data
        queryClient.invalidateQueries({ queryKey: ["/api/streams/live"] });
      }
    } catch (error) {
      toast({
        title: "Error",
        description: "Failed to add co-star. Please try again.",
        variant: "destructive"
      });
    }
  }, [selectedStream, user, coStarName, coStarEmail, toast, queryClient]);

  const formatRecordingTime = (seconds: number) => {
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = seconds % 60;
    if (hrs > 0) {
      return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  const joinStream = useCallback(async (stream: LiveStream) => {
    if (stream.isPremium && stream.ticketPrice && !user) {
      toast({
        title: "Premium Content",
        description: "Please sign in to access premium streams",
        variant: "destructive"
      });
      return;
    }

    try {
      setSelectedStream(stream);
      setChatMessages([]);
      
      // Track stream view
      await fetch('/api/streams/view', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ streamId: stream.id })
      });
    } catch (error) {
      console.error('Failed to join stream:', error);
    }
  }, [user, toast]);

  const filteredStreams = useMemo(() => {
    let streams = mockStreams;
    
    if (debouncedSearchQuery) {
      const query = debouncedSearchQuery.toLowerCase();
      streams = streams.filter(stream => 
        stream.title.toLowerCase().includes(query) ||
        stream.creatorName.toLowerCase().includes(query) ||
        stream.description.toLowerCase().includes(query) ||
        stream.tags.some(tag => tag.toLowerCase().includes(query))
      );
    }
    
    if (selectedCategory !== "all") {
      streams = streams.filter(stream => stream.category === selectedCategory);
    }
    
    return streams;
  }, [debouncedSearchQuery, selectedCategory]);

  const liveStreamsNow = filteredStreams.filter(stream => stream.isLive);
  const scheduledStreamsData = filteredStreams.filter(stream => !stream.isLive);

  return (
    <div className="min-h-screen bg-gray-900">
      <Navigation unreadCount={unreadCount as number} />
      
      <div className="container mx-auto px-4 py-6">
        {/* Header */}
        <div className="flex items-center justify-between mb-8">
          <div>
            <h1 className="text-4xl font-bold text-white mb-2 flex items-center">
              <Video className="w-8 h-8 mr-3 text-primary" />
              FanzLive
            </h1>
            <p className="text-gray-400">Live streaming with your favorite creators</p>
          </div>
          
          {(user as any)?.role === 'creator' && (
            <Link href="/creator-dashboard">
              <Button className="bg-gradient-to-r from-primary to-secondary hover:from-purple-600 hover:to-pink-600">
                <Camera className="w-4 h-4 mr-2" />
                Go Live
              </Button>
            </Link>
          )}
        </div>

        {/* Search Bar */}
        <div className="relative mb-8">
          <Search className="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5" />
          <Input
            type="text"
            placeholder="Search live streams, creators, topics..."
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            className="bg-gray-800 border-gray-700 pl-12 py-3 text-white placeholder-gray-400 text-lg focus:ring-2 focus:ring-primary/50 transition-all"
            data-testid="input-stream-search"
          />
          {searchQuery && (
            <Button
              size="sm"
              variant="ghost"
              className="absolute right-2 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-white"
              onClick={() => setSearchQuery('')}
            >
              âœ•
            </Button>
          )}
        </div>

        {/* Connection Status */}
        {selectedStream && connectionError && (
          <Alert className="mb-6 bg-red-900/20 border-red-900/50">
            <AlertDescription className="text-red-200">
              {connectionError}
            </AlertDescription>
          </Alert>
        )}

        {/* Compliance Alert */}
        {showComplianceAlert && selectedStream?.hasCoStars && (
          <Alert className="mb-6 bg-yellow-900/20 border-yellow-900/50">
            <AlertTriangle className="h-4 w-4" />
            <AlertDescription className="text-yellow-200">
              This stream contains co-stars. Please ensure all participants have completed 2257 compliance verification.
              <Button 
                size="sm" 
                variant="outline" 
                className="ml-2 text-yellow-200 border-yellow-200"
                onClick={() => setShowComplianceAlert(false)}
              >
                Acknowledge
              </Button>
            </AlertDescription>
          </Alert>
        )}

        {/* Loading State */}
        {streamsLoading && (
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            {[1, 2, 3, 4].map((i) => (
              <Card key={i} className="bg-gray-800 border-gray-700">
                <Skeleton className="w-full h-48 bg-gray-700" />
                <CardContent className="p-4">
                  <Skeleton className="h-6 w-3/4 mb-2 bg-gray-700" />
                  <Skeleton className="h-4 w-1/2 mb-4 bg-gray-700" />
                  <div className="flex space-x-2">
                    <Skeleton className="h-6 w-16 bg-gray-700" />
                    <Skeleton className="h-6 w-20 bg-gray-700" />
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        )}

        {/* Error State */}
        {streamsError && (
          <Alert className="mb-6 bg-red-900/20 border-red-900/50">
            <AlertDescription className="text-red-200">
              Failed to load streams. Please refresh the page.
            </AlertDescription>
          </Alert>
        )}

        {selectedStream ? (
          /* Stream Viewer */
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
            {/* Video Player */}
            <div className="lg:col-span-3">
              <div className="bg-black rounded-lg overflow-hidden relative group">
                <div className="relative" onMouseMove={handleMouseMove}>
                  <video
                    ref={videoRef}
                    src={selectedStream.streamUrl}
                    className="w-full aspect-video object-cover cursor-pointer"
                    autoPlay
                    playsInline
                    data-testid="stream-video-player"
                    onClick={() => {
                      if (videoRef.current) {
                        if (videoRef.current.paused) {
                          videoRef.current.play();
                        } else {
                          videoRef.current.pause();
                        }
                      }
                    }}
                  />
                  
                  {/* Stream Overlay */}
                  <div className="absolute top-4 left-4 flex items-center space-x-2">
                    <Badge className="bg-red-600 text-white">
                      <div className="w-2 h-2 bg-white rounded-full animate-pulse mr-1"></div>
                      LIVE
                    </Badge>
                    <Badge className="bg-black/50 text-white">
                      <Users className="w-3 h-3 mr-1" />
                      {selectedStream.viewers.toLocaleString()}
                    </Badge>
                  </div>

                  {/* Enhanced Video Controls */}
                  <div className={`absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/60 transition-opacity duration-300 ${showVideoControls ? 'opacity-100' : 'opacity-0'}`}>
                    {/* Top Controls */}
                    <div className="absolute top-4 left-4 right-4 flex items-center justify-between">
                      {/* Recording Status & Controls */}
                      <div className="flex items-center space-x-2">
                        {(user as any)?.role === 'creator' && selectedStream?.creatorId === (user as any)?.id?.toString() || '' && (
                          <>
                            {isRecording ? (
                              <>
                                <Button
                                  size="sm"
                                  variant="ghost"
                                  className="bg-red-600/80 text-white hover:bg-red-700/80"
                                  onClick={stopRecording}
                                >
                                  <StopCircle className="w-4 h-4 mr-1" />
                                  {formatRecordingTime(recordingDuration)}
                                </Button>
                                <div className="w-3 h-3 bg-red-500 rounded-full animate-pulse" />
                              </>
                            ) : (
                              <Button
                                size="sm"
                                variant="ghost"
                                className="bg-black/50 text-white hover:bg-black/70"
                                onClick={startRecording}
                              >
                                <FileVideo className="w-4 h-4 mr-1" />
                                Record
                              </Button>
                            )}
                            <Button
                              size="sm"
                              variant="ghost"
                              className="bg-black/50 text-white hover:bg-black/70"
                              onClick={() => setShowCoStarModal(true)}
                            >
                              <UserPlus className="w-4 h-4 mr-1" />
                              Add Co-star
                            </Button>
                          </>
                        )}
                        
                        {/* Video Quality Indicator */}
                        <Badge className="bg-black/50 text-white text-xs">
                          <Monitor className="w-3 h-3 mr-1" />
                          {videoQuality === 'auto' ? 'Auto' : videoQuality}
                        </Badge>
                        
                        {/* Connection Quality */}
                        <Badge className={`text-white text-xs ${
                          isConnected 
                            ? streamBitrate > 2000 ? 'bg-green-600/80' : 'bg-yellow-600/80'
                            : 'bg-red-600/80'
                        }`}>
                          {isConnected ? <Wifi className="w-3 h-3 mr-1" /> : <WifiOff className="w-3 h-3 mr-1" />}
                          {isConnected ? `${streamBitrate}kbps` : 'Offline'}
                        </Badge>
                      </div>
                      
                      {/* Player Controls */}
                      <div className="flex items-center space-x-2">
                      <Button 
                        size="sm" 
                        variant="ghost" 
                        className="bg-black/50 text-white hover:bg-black/70"
                        onClick={() => setIsVideoMuted(!isVideoMuted)}
                      >
                        {isVideoMuted ? <VolumeX className="w-4 h-4" /> : <Volume2 className="w-4 h-4" />}
                      </Button>
                      <Button size="sm" variant="ghost" className="bg-black/50 text-white hover:bg-black/70">
                        <Settings className="w-4 h-4" />
                      </Button>
                      <Button 
                        size="sm" 
                        variant="ghost" 
                        className="bg-black/50 text-white hover:bg-black/70"
                        onClick={() => setIsFullscreen(!isFullscreen)}
                      >
                        {isFullscreen ? <Minimize2 className="w-4 h-4" /> : <Maximize2 className="w-4 h-4" />}
                      </Button>
                    </div>

                    {/* Bottom Controls */}
                    <div className="absolute bottom-4 left-4 right-4">
                      <div className="flex items-center space-x-4">
                        <div className="flex items-center space-x-2 text-white">
                          <Volume2 className="w-4 h-4" />
                          <Slider
                            value={volume}
                            onValueChange={setVolume}
                            max={100}
                            step={1}
                            className="w-20"
                          />
                        </div>
                        <div className="flex-1" />
                        <Badge className={`${isConnected ? 'bg-green-600' : 'bg-red-600'} text-white`}>
                          {isConnected ? 'Connected' : 'Disconnected'}
                        </Badge>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* Stream Info */}
              <div className="mt-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="flex-1">
                    <h2 className="text-2xl font-bold text-white mb-2">{selectedStream.title}</h2>
                    <p className="text-gray-300 mb-3">{selectedStream.description}</p>
                    
                    <div className="flex items-center space-x-4 mb-4">
                      <Link href={`/creator/${selectedStream.creatorName.toLowerCase().replace(' ', '')}`}>
                        <div className="flex items-center space-x-3">
                          <Avatar className="w-10 h-10">
                            <AvatarImage src={selectedStream.creatorAvatar} alt={selectedStream.creatorName} />
                            <AvatarFallback>{selectedStream.creatorName[0]}</AvatarFallback>
                          </Avatar>
                          <div>
                            <p className="font-semibold text-white">{selectedStream.creatorName}</p>
                            <p className="text-sm text-gray-400">Live for {Math.floor((Date.now() - new Date(selectedStream.startedAt).getTime()) / 60000)} minutes</p>
                          </div>
                        </div>
                      </Link>
                    </div>

                    <div className="flex items-center space-x-2 mb-4">
                      {selectedStream.tags.map((tag) => (
                        <Badge key={tag} variant="secondary" className="text-xs">
                          {tag}
                        </Badge>
                      ))}
                    </div>
                  </div>

                  <div className="flex items-center space-x-2">
                    <Button
                      variant={selectedStream.isFollowing ? "outline" : "default"}
                      className={selectedStream.isFollowing ? "border-primary text-primary" : "bg-primary"}
                    >
                      {selectedStream.isFollowing ? "Following" : "Follow"}
                    </Button>
                    <Button variant="ghost">
                      <Bell className="w-4 h-4" />
                    </Button>
                    <Button variant="ghost">
                      <Share2 className="w-4 h-4" />
                    </Button>
                    <Button variant="ghost">
                      <MoreVertical className="w-4 h-4" />
                    </Button>
                  </div>
                </div>

                {/* Tip Goal */}
                {selectedStream.tipGoal && (
                  <Card className="bg-gray-800 border-gray-700 mb-4">
                    <CardContent className="p-4">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm text-gray-400">Tip Goal</span>
                        <span className="text-sm text-white">
                          ${selectedStream.currentTips} / ${selectedStream.tipGoal}
                        </span>
                      </div>
                      <div className="w-full bg-gray-700 rounded-full h-2">
                        <div 
                          className="bg-gradient-to-r from-primary to-secondary h-2 rounded-full transition-all"
                          style={{ width: `${((selectedStream.currentTips || 0) / selectedStream.tipGoal) * 100}%` }}
                        ></div>
                      </div>
                    </CardContent>
                  </Card>
                )}

                {/* Co-stars Display */}
                {selectedStream.coStars && selectedStream.coStars.length > 0 && (
                  <Card className="bg-gray-800 border-gray-700 mb-4">
                    <CardContent className="p-4">
                      <h4 className="text-white font-semibold mb-3 flex items-center">
                        <Users className="w-4 h-4 mr-2" />
                        Co-stars in this stream
                      </h4>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {selectedStream.coStars.map((coStar) => (
                          <div key={coStar.id} className="flex items-center justify-between p-2 bg-gray-700 rounded">
                            <div className="flex items-center space-x-2">
                              <Avatar className="w-6 h-6">
                                <AvatarImage src={coStar.avatar} alt={coStar.name} />
                                <AvatarFallback>{coStar.name[0]}</AvatarFallback>
                              </Avatar>
                              <span className="text-white text-sm">{coStar.name}</span>
                            </div>
                            <div className="flex items-center space-x-1">
                              {coStar.verificationStatus === 'verified' ? (
                                <CheckCircle className="w-4 h-4 text-green-500" />
                              ) : coStar.verificationStatus === 'rejected' ? (
                                <XCircle className="w-4 h-4 text-red-500" />
                              ) : (
                                <AlertTriangle className="w-4 h-4 text-yellow-500" />
                              )}
                              <Badge 
                                variant={coStar.verificationStatus === 'verified' ? 'default' : 'secondary'}
                                className="text-xs"
                              >
                                {coStar.verificationStatus}
                              </Badge>
                            </div>
                          </div>
                        ))}
                      </div>
                      {selectedStream.coStars.some(cs => cs.verificationStatus !== 'verified') && (
                        <p className="text-yellow-400 text-xs mt-2 flex items-center">
                          <Shield className="w-3 h-3 mr-1" />
                          All co-stars must complete 2257 compliance verification
                        </p>
                      )}
                    </CardContent>
                  </Card>
                )}

                {/* Quick Actions */}
                <div className="flex items-center space-x-3">
                  <Button className="bg-gradient-to-r from-primary to-secondary hover:from-purple-600 hover:to-pink-600">
                    <Heart className="w-4 h-4 mr-2" />
                    Like
                  </Button>
                  <Button 
                    variant="outline"
                    onClick={() => setShowTipModal(true)}
                    className="border-yellow-500 text-yellow-500 hover:bg-yellow-500 hover:text-black"
                  >
                    <Gift className="w-4 h-4 mr-2" />
                    Send Tip
                  </Button>
                  <Button variant="outline">
                    <Bookmark className="w-4 h-4 mr-2" />
                    Save
                  </Button>
                  {(user as any)?.role === 'creator' && selectedStream?.creatorId === (user as any)?.id?.toString() || '' && (
                    <Button variant="outline" asChild>
                      <Link href="/creator-dashboard?tab=vault">
                        <FileVideo className="w-4 h-4 mr-2" />
                        View Vault
                      </Link>
                    </Button>
                  )}
                </div>
              </div>
            </div>

            {/* Chat Sidebar */}
            <div className="bg-gray-800 rounded-lg border border-gray-700 flex flex-col h-[600px]">
              <div className="p-4 border-b border-gray-700">
                <h3 className="font-semibold text-white flex items-center">
                  <MessageCircle className="w-4 h-4 mr-2" />
                  Live Chat
                  <Badge className="ml-2 bg-primary text-white text-xs">
                    {selectedStream.viewers}
                  </Badge>
                </h3>
              </div>

              <ScrollArea className="flex-1 p-4">
                <div className="space-y-3">
                  {chatMessages.map((message) => (
                    <div key={message.id} className="flex items-start space-x-2">
                      <Avatar className="w-6 h-6">
                        <AvatarImage src={message.userAvatar} alt={message.username} />
                        <AvatarFallback className="text-xs">{message.username[0]}</AvatarFallback>
                      </Avatar>
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center space-x-1">
                          <span className={`text-sm font-medium ${
                            message.isModerator ? 'text-green-400' : 
                            message.isVip ? 'text-yellow-400' : 
                            'text-white'
                          }`}>
                            {message.username}
                          </span>
                          {message.isModerator && <Crown className="w-3 h-3 text-green-400" />}
                          {message.isVip && <Star className="w-3 h-3 text-yellow-400" />}
                          {message.tipAmount && (
                            <Badge className="bg-yellow-600 text-white text-xs">
                              ${message.tipAmount}
                            </Badge>
                          )}
                        </div>
                        <p className="text-sm text-gray-300 break-words">{message.message}</p>
                      </div>
                    </div>
                  ))}
                  <div ref={chatEndRef} />
                </div>
              </ScrollArea>

              <div className="p-4 border-t border-gray-700">
                <div className="flex space-x-2">
                  <Input
                    value={chatMessage}
                    onChange={(e) => setChatMessage(e.target.value)}
                    placeholder={isConnected ? "Type a message..." : "Connecting..."}
                    className="bg-gray-700 border-gray-600 text-white focus:ring-2 focus:ring-primary/50"
                    onKeyPress={(e) => e.key === 'Enter' && sendChatMessage()}
                    disabled={!isConnected}
                    data-testid="input-chat-message"
                  />
                  <Button 
                    onClick={sendChatMessage} 
                    size="sm" 
                    className="bg-primary hover:bg-primary/90 disabled:opacity-50"
                    disabled={!isConnected || !chatMessage.trim()}
                  >
                    Send
                  </Button>
                </div>
              </div>
            </div>
          </div>
        ) : (
          /* Stream Browser */
          <div className="grid grid-cols-1 lg:grid-cols-4 gap-8">
            {/* Main Content */}
            <div className="lg:col-span-3">
              <Tabs defaultValue="live" className="space-y-6">
                <TabsList className="bg-gray-800 border border-gray-700 p-1">
                  <TabsTrigger value="live" className="flex items-center" data-testid="tab-live">
                    <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-2"></div>
                    Live Now ({liveStreamsNow.length})
                  </TabsTrigger>
                  <TabsTrigger value="scheduled" className="flex items-center" data-testid="tab-scheduled">
                    <Calendar className="w-4 h-4 mr-2" />
                    Scheduled
                  </TabsTrigger>
                  <TabsTrigger value="trending" className="flex items-center" data-testid="tab-trending">
                    <TrendingUp className="w-4 h-4 mr-2" />
                    Trending
                  </TabsTrigger>
                </TabsList>

                {/* Live Now Tab */}
                <TabsContent value="live" className="space-y-6">
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {liveStreamsNow.map((stream) => (
                      <Card 
                        key={stream.id} 
                        className="bg-gray-800 border-gray-700 overflow-hidden cursor-pointer hover:shadow-xl transition-all"
                        onClick={() => joinStream(stream)}
                      >
                        <div className="relative">
                          <img
                            src={stream.thumbnailUrl}
                            alt={stream.title}
                            className="w-full h-48 object-cover"
                          />
                          
                          {/* Overlay */}
                          <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent" />
                          
                          {/* Live Badge */}
                          <div className="absolute top-3 left-3">
                            <Badge className="bg-red-600 text-white">
                              <div className="w-2 h-2 bg-white rounded-full animate-pulse mr-1"></div>
                              LIVE
                            </Badge>
                          </div>

                          {/* Premium Badge */}
                          {stream.isPremium && (
                            <div className="absolute top-3 right-3">
                              <Badge className="bg-yellow-600 text-white">
                                <Crown className="w-3 h-3 mr-1" />
                                ${stream.ticketPrice}
                              </Badge>
                            </div>
                          )}

                          {/* Viewer Count */}
                          <div className="absolute bottom-3 right-3 bg-black/60 px-2 py-1 rounded text-sm text-white">
                            <Users className="w-3 h-3 inline mr-1" />
                            {stream.viewers.toLocaleString()}
                          </div>

                          {/* Duration */}
                          <div className="absolute bottom-3 left-3 bg-black/60 px-2 py-1 rounded text-sm text-white">
                            {Math.floor((Date.now() - new Date(stream.startedAt).getTime()) / 60000)}m
                          </div>

                          {/* Play Button */}
                          <div className="absolute inset-0 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity">
                            <div className="bg-white/20 backdrop-blur-sm rounded-full p-4">
                              <Play className="w-8 h-8 text-white fill-white" />
                            </div>
                          </div>
                        </div>

                        <CardContent className="p-4">
                          <div className="flex items-center space-x-3 mb-3">
                            <Avatar className="w-8 h-8">
                              <AvatarImage src={stream.creatorAvatar} alt={stream.creatorName} />
                              <AvatarFallback>{stream.creatorName[0]}</AvatarFallback>
                            </Avatar>
                            <div>
                              <p className="text-white font-medium">{stream.creatorName}</p>
                              <p className="text-gray-400 text-sm">{stream.category}</p>
                            </div>
                          </div>
                          
                          <h3 className="text-white font-semibold mb-2 line-clamp-2">{stream.title}</h3>
                          
                          <div className="flex items-center space-x-2">
                            {stream.tags.slice(0, 2).map((tag) => (
                              <Badge key={tag} variant="secondary" className="text-xs">
                                {tag}
                              </Badge>
                            ))}
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </TabsContent>

                {/* Scheduled Tab */}
                <TabsContent value="scheduled" className="space-y-6">
                  <div className="grid gap-4">
                    {scheduledStreamsData.map((stream) => (
                      <Card key={stream.id} className="bg-gray-800 border-gray-700">
                        <CardContent className="p-4">
                          <div className="flex items-center space-x-4">
                            <img
                              src={stream.thumbnailUrl}
                              alt={stream.title}
                              className="w-24 h-16 rounded object-cover"
                            />
                            <div className="flex-1">
                              <h4 className="text-white font-semibold mb-1">{stream.title}</h4>
                              <p className="text-gray-400 text-sm mb-2">{stream.creatorName}</p>
                              <div className="flex items-center space-x-4 text-xs text-gray-400">
                                <span className="flex items-center">
                                  <Calendar className="w-3 h-3 mr-1" />
                                  {new Date(stream.startedAt).toLocaleDateString()}
                                </span>
                                <span className="flex items-center">
                                  <Clock className="w-3 h-3 mr-1" />
                                  {new Date(stream.startedAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                                </span>
                                <Badge variant="secondary" className="text-xs">
                                  {stream.category}
                                </Badge>
                              </div>
                            </div>
                            <Button size="sm" variant="outline">
                              <Bell className="w-4 h-4 mr-1" />
                              Remind Me
                            </Button>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </TabsContent>

                {/* Trending Tab */}
                <TabsContent value="trending" className="space-y-6">
                  <div className="grid gap-4">
                    {mockStreams.slice().sort((a, b) => b.totalViews - a.totalViews).map((stream, index) => (
                      <Card key={stream.id} className="bg-gray-800 border-gray-700">
                        <CardContent className="p-4">
                          <div className="flex items-center space-x-4">
                            <div className="flex items-center justify-center w-8 h-8 bg-primary rounded-full text-white font-bold">
                              {index + 1}
                            </div>
                            <img
                              src={stream.thumbnailUrl}
                              alt={stream.title}
                              className="w-20 h-14 rounded object-cover"
                            />
                            <div className="flex-1">
                              <h4 className="text-white font-semibold mb-1">{stream.title}</h4>
                              <p className="text-gray-400 text-sm">{stream.creatorName}</p>
                              <div className="flex items-center space-x-4 text-xs text-gray-400 mt-1">
                                <span className="flex items-center">
                                  <TrendingUp className="w-3 h-3 mr-1 text-green-500" />
                                  {stream.totalViews.toLocaleString()} views
                                </span>
                                {stream.isLive && (
                                  <span className="flex items-center text-red-400">
                                    <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-1"></div>
                                    LIVE
                                  </span>
                                )}
                              </div>
                            </div>
                            <Button
                              size="sm"
                              onClick={() => joinStream(stream)}
                              className="bg-primary"
                            >
                              {stream.isLive ? "Watch" : "Schedule"}
                            </Button>
                          </div>
                        </CardContent>
                      </Card>
                    ))}
                  </div>
                </TabsContent>
              </Tabs>
            </div>

            {/* Sidebar */}
            <div className="space-y-6">
              {/* Categories */}
              <Card className="bg-gray-800 border-gray-700">
                <CardHeader>
                  <CardTitle className="text-white flex items-center">
                    <Video className="w-5 h-5 mr-2 text-primary" />
                    Categories
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-2">
                  {categories.map((category) => (
                    <button
                      key={category.id}
                      onClick={() => setSelectedCategory(category.id)}
                      className={`w-full text-left p-2 rounded-lg transition-colors flex items-center justify-between ${
                        selectedCategory === category.id 
                          ? 'bg-primary text-white' 
                          : 'text-gray-400 hover:bg-gray-700 hover:text-white'
                      }`}
                      data-testid={`category-${category.id}`}
                    >
                      <span>{category.name}</span>
                      <Badge variant="secondary" className="text-xs">
                        {category.count}
                      </Badge>
                    </button>
                  ))}
                </CardContent>
              </Card>

              {/* Platform Stats */}
              <Card className="bg-gray-800 border-gray-700">
                <CardHeader>
                  <CardTitle className="text-white flex items-center">
                    <TrendingUp className="w-5 h-5 mr-2 text-primary" />
                    Live Stats
                  </CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="flex justify-between">
                    <span className="text-gray-400">Live Now</span>
                    <span className="font-semibold text-red-400 flex items-center">
                      <div className="w-2 h-2 bg-red-500 rounded-full animate-pulse mr-1"></div>
                      {liveStreamsNow.length}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Total Viewers</span>
                    <span className="font-semibold text-white">
                      {liveStreamsNow.reduce((sum, s) => sum + s.viewers, 0).toLocaleString()}
                    </span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Scheduled Today</span>
                    <span className="font-semibold text-white">{scheduledStreamsData.length}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-gray-400">Total Streams</span>
                    <span className="font-semibold text-white">{mockStreams.length}</span>
                  </div>
                </CardContent>
              </Card>
            </div>
          </div>
        )}

        {/* Tip Modal */}
        <Dialog open={showTipModal} onOpenChange={setShowTipModal}>
          <DialogContent className="bg-gray-800 border-gray-700">
            <DialogHeader>
              <DialogTitle className="text-white">Send a Tip</DialogTitle>
              <DialogDescription className="text-gray-400">
                Show your support to {selectedStream?.creatorName}
              </DialogDescription>
            </DialogHeader>
            
            <div className="space-y-4">
              <div className="grid grid-cols-3 gap-3">
                {tipOptions.map((option) => (
                  <Button
                    key={option.amount}
                    variant="outline"
                    className="flex flex-col items-center p-4 h-auto border-gray-600"
                    onClick={() => sendTip(option.amount, option.message)}
                  >
                    <span className="text-2xl mb-1">{option.emoji}</span>
                    <span className="font-semibold">${option.amount}</span>
                    <span className="text-xs text-gray-400">{option.message}</span>
                  </Button>
                ))}
              </div>
              
              <div className="space-y-3">
                <Input
                  type="number"
                  placeholder="Custom amount"
                  value={tipAmount}
                  onChange={(e) => setTipAmount(e.target.value)}
                  className="bg-gray-700 border-gray-600 text-white"
                />
                <Textarea
                  placeholder="Add a message (optional)"
                  value={tipMessage}
                  onChange={(e) => setTipMessage(e.target.value)}
                  className="bg-gray-700 border-gray-600 text-white"
                />
                <Button
                  onClick={() => sendTip(parseInt(tipAmount) || 0, tipMessage)}
                  disabled={!tipAmount || parseInt(tipAmount) <= 0}
                  className="w-full bg-gradient-to-r from-primary to-secondary"
                >
                  <Gift className="w-4 h-4 mr-2" />
                  Send ${tipAmount || 0} Tip
                </Button>
              </div>
            </div>
          </DialogContent>
        </Dialog>

        {/* Co-star Addition Modal */}
        <Dialog open={showCoStarModal} onOpenChange={setShowCoStarModal}>
          <DialogContent className="bg-gray-800 border-gray-700 text-white">
            <DialogHeader>
              <DialogTitle className="flex items-center">
                <UserPlus className="w-5 h-5 mr-2 text-primary" />
                Add Co-star to Stream
              </DialogTitle>
              <DialogDescription className="text-gray-400">
                Add a co-star to your live stream. All co-stars must complete 2257 compliance verification.
              </DialogDescription>
            </DialogHeader>
            
            <div className="space-y-4">
              <div>
                <Label htmlFor="costar-name" className="text-white">Co-star Name</Label>
                <Input
                  id="costar-name"
                  value={coStarName}
                  onChange={(e) => setCoStarName(e.target.value)}
                  placeholder="Enter co-star's full legal name"
                  className="bg-gray-700 border-gray-600 text-white"
                  data-testid="input-costar-name"
                />
              </div>
              
              <div>
                <Label htmlFor="costar-email" className="text-white">Email Address</Label>
                <Input
                  id="costar-email"
                  type="email"
                  value={coStarEmail}
                  onChange={(e) => setCoStarEmail(e.target.value)}
                  placeholder="Enter co-star's email for verification"
                  className="bg-gray-700 border-gray-600 text-white"
                  data-testid="input-costar-email"
                />
              </div>
              
              <Alert className="bg-yellow-900/20 border-yellow-900/50">
                <Shield className="h-4 w-4" />
                <AlertDescription className="text-yellow-200">
                  By adding a co-star, you confirm that they are 18+ years old and will complete all required 2257 compliance documentation before appearing on stream.
                </AlertDescription>
              </Alert>
            </div>
            
            <DialogFooter>
              <Button 
                variant="outline" 
                onClick={() => setShowCoStarModal(false)}
                className="border-gray-600 text-gray-300"
              >
                Cancel
              </Button>
              <Button 
                onClick={addCoStar}
                disabled={!coStarName || !coStarEmail}
                className="bg-primary hover:bg-primary/90"
                data-testid="button-add-costar"
              >
                Add Co-star
              </Button>
            </DialogFooter>
          </DialogContent>
        </Dialog>
      </div>
    </div>
  );
}