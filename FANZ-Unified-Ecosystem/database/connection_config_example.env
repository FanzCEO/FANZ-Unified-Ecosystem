# =====================================================
# FANZ Unified Ecosystem - Database Connection Configuration
# =====================================================
# Copy this file to each platform's .env and configure
# with appropriate credentials
# =====================================================

# =====================================================
# Database Connection
# =====================================================

# Primary database connection (read-write)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=fanz_ecosystem
DB_USER=svc_platform_api
DB_PASSWORD=CHANGE_ME_PLATFORM_API

# Connection pool settings
DB_POOL_MIN=2
DB_POOL_MAX=10
DB_POOL_IDLE_TIMEOUT=10000

# SSL settings (REQUIRED in production)
DB_SSL_ENABLED=true
DB_SSL_REJECT_UNAUTHORIZED=true
DB_SSL_CA_PATH=/path/to/ca-certificate.crt

# =====================================================
# Read Replica (Optional - for analytics queries)
# =====================================================

DB_REPLICA_HOST=localhost-replica
DB_REPLICA_PORT=5432
DB_REPLICA_USER=analytics_ro
DB_REPLICA_PASSWORD=CHANGE_ME_ANALYTICS

# =====================================================
# Connection String Examples
# =====================================================

# PostgreSQL connection string format:
# postgresql://[user]:[password]@[host]:[port]/[database]?[options]

# Example: Primary connection
# DATABASE_URL=postgresql://svc_platform_api:password@localhost:5432/fanz_ecosystem?sslmode=require

# Example: With connection pooling
# DATABASE_URL=postgresql://svc_platform_api:password@localhost:5432/fanz_ecosystem?sslmode=require&pool_max=10

# Example: PgBouncer connection
# DATABASE_URL=postgresql://svc_platform_api:password@pgbouncer:6432/fanz_ecosystem?sslmode=require

# =====================================================
# Service-Specific Users
# =====================================================

# FanzSSO Service
FANZSSO_DB_USER=svc_fanzsso
FANZSSO_DB_PASSWORD=CHANGE_ME_FANZSSO

# FanzMoney Service
FANZMONEY_DB_USER=svc_fanzmoney
FANZMONEY_DB_PASSWORD=CHANGE_ME_FANZMONEY

# FanzMedia Service
FANZMEDIA_DB_USER=svc_fanzmedia
FANZMEDIA_DB_PASSWORD=CHANGE_ME_FANZMEDIA

# Analytics Service
ANALYTICS_DB_USER=svc_analytics
ANALYTICS_DB_PASSWORD=CHANGE_ME_ANALYTICS

# =====================================================
# Platform Context (Required for multi-tenancy)
# =====================================================

# Platform identifier (one of 94 platforms)
PLATFORM_ID=boyfanz

# Tenant identifier
TENANT_ID=00000000-0000-0000-0000-000000000001

# =====================================================
# Application Settings
# =====================================================

# These settings are passed to PostgreSQL session
# for Row Level Security policies

# Set current user ID (for RLS policies)
# app.current_user_id=uuid

# Set current user role (for RLS policies)
# app.user_role=admin|user|legal_ops|etc

# Set service name (for secrets access)
# app.service_name=fanzsso|fanzmoney|etc

# =====================================================
# Node.js Connection Example (pg library)
# =====================================================

# const { Pool } = require('pg');
#
# const pool = new Pool({
#   host: process.env.DB_HOST,
#   port: process.env.DB_PORT,
#   database: process.env.DB_NAME,
#   user: process.env.DB_USER,
#   password: process.env.DB_PASSWORD,
#   ssl: process.env.DB_SSL_ENABLED === 'true' ? {
#     rejectUnauthorized: process.env.DB_SSL_REJECT_UNAUTHORIZED === 'true'
#   } : false,
#   min: parseInt(process.env.DB_POOL_MIN),
#   max: parseInt(process.env.DB_POOL_MAX),
#   idleTimeoutMillis: parseInt(process.env.DB_POOL_IDLE_TIMEOUT),
#   application_name: process.env.PLATFORM_ID
# });
#
# // Set session variables for RLS
# pool.on('connect', (client) => {
#   client.query(`SET app.platform_id = '${process.env.PLATFORM_ID}'`);
#   client.query(`SET app.tenant_id = '${process.env.TENANT_ID}'`);
# });

# =====================================================
# TypeScript/Prisma Example
# =====================================================

# DATABASE_URL="postgresql://svc_platform_api:password@localhost:5432/fanz_ecosystem?schema=public&connection_limit=10"

# =====================================================
# Python Connection Example (psycopg2)
# =====================================================

# import psycopg2
# from psycopg2.pool import SimpleConnectionPool
#
# pool = SimpleConnectionPool(
#     minconn=int(os.getenv('DB_POOL_MIN', 2)),
#     maxconn=int(os.getenv('DB_POOL_MAX', 10)),
#     host=os.getenv('DB_HOST'),
#     port=os.getenv('DB_PORT'),
#     database=os.getenv('DB_NAME'),
#     user=os.getenv('DB_USER'),
#     password=os.getenv('DB_PASSWORD'),
#     sslmode='require' if os.getenv('DB_SSL_ENABLED') == 'true' else 'disable',
#     application_name=os.getenv('PLATFORM_ID')
# )

# =====================================================
# Connection Health Check
# =====================================================

# Implement health checks in your application:
#
# async function checkDatabaseHealth() {
#   try {
#     const result = await pool.query('SELECT 1 as health');
#     return result.rows[0].health === 1;
#   } catch (error) {
#     console.error('Database health check failed:', error);
#     return false;
#   }
# }

# =====================================================
# Migration Configuration
# =====================================================

# Flyway
# FLYWAY_URL=jdbc:postgresql://localhost:5432/fanz_ecosystem
# FLYWAY_USER=admin
# FLYWAY_PASSWORD=admin_password
# FLYWAY_SCHEMAS=public,ledger,catalog,creators,fans
# FLYWAY_LOCATIONS=filesystem:./database/migrations

# =====================================================
# Backup Configuration
# =====================================================

# Backup connection (read-only)
BACKUP_DB_HOST=localhost
BACKUP_DB_PORT=5432
BACKUP_DB_USER=backup_user
BACKUP_DB_PASSWORD=CHANGE_ME_BACKUP

# Backup schedule (cron format)
BACKUP_SCHEDULE="0 2 * * *"  # 2 AM daily

# Backup retention
BACKUP_RETENTION_DAYS=30

# =====================================================
# Monitoring Configuration
# =====================================================

# Connection monitoring
MONITOR_SLOW_QUERY_THRESHOLD=1000  # milliseconds
MONITOR_CONNECTION_TIMEOUT=30000   # milliseconds

# Query logging
LOG_QUERIES=false
LOG_QUERY_PARAMETERS=false
LOG_SLOW_QUERIES_ONLY=true

# =====================================================
# Security Notes
# =====================================================

# 1. NEVER commit this file with actual passwords
# 2. Use environment-specific .env files (.env.production, .env.staging)
# 3. Store secrets in a secrets manager (AWS Secrets Manager, Vault, etc.)
# 4. Rotate passwords regularly
# 5. Use SSL/TLS in production (DB_SSL_ENABLED=true)
# 6. Limit connection pool size based on your database resources
# 7. Use read replicas for analytics to reduce load on primary
# 8. Monitor connection pool exhaustion

# =====================================================
# Troubleshooting
# =====================================================

# Connection refused:
#   - Check DB_HOST and DB_PORT
#   - Ensure PostgreSQL is running
#   - Check firewall rules

# Authentication failed:
#   - Verify DB_USER and DB_PASSWORD
#   - Check pg_hba.conf for access rules
#   - Ensure role exists: SELECT * FROM pg_roles WHERE rolname = 'your_user';

# SSL connection error:
#   - Set DB_SSL_ENABLED=false for development
#   - Ensure SSL certificates are valid
#   - Check DB_SSL_CA_PATH

# Connection pool exhausted:
#   - Increase DB_POOL_MAX
#   - Check for connection leaks
#   - Review slow queries
#   - Consider using PgBouncer

# =====================================================
# Additional Resources
# =====================================================

# Documentation: /database/README.md
# Schema files: /database/schemas/
# Verification: psql fanz_ecosystem -f database/verify_schemas.sql
